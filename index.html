<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeatCert Pro - BRCGS Certification Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
:root {
    --primary-blue: #1e3a5f;
    --primary-blue-light: #2d5a8b;
    --primary-green: #2d7d46;
    --primary-green-light: #3d9d5c;
    --accent-orange: #e67e22;
    --accent-red: #c0392b;
    --accent-yellow: #f39c12;
    --white: #ffffff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --grade-aa: #059669;
    --grade-a: #10b981;
    --grade-b: #f59e0b;
    --grade-c: #ef4444;
    --grade-d: #dc2626;
    --status-active: #059669;
    --status-expiring: #f59e0b;
    --status-expired: #dc2626;
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    --transition-fast: 150ms ease;
    --transition-normal: 300ms ease;
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --radius-full: 9999px;
}
[data-theme="dark"] {
    --white: #1f2937;
    --gray-50: #111827;
    --gray-100: #1f2937;
    --gray-200: #374151;
    --gray-300: #4b5563;
    --gray-400: #6b7280;
    --gray-500: #9ca3af;
    --gray-600: #d1d5db;
    --gray-700: #e5e7eb;
    --gray-800: #f3f4f6;
    --gray-900: #f9fafb;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--gray-50);
    color: var(--gray-800);
    line-height: 1.6;
    min-height: 100vh;
}
.hidden { display: none !important; }
.w-full { width: 100%; }
.mt-4 { margin-top: 1rem; }
.mb-2 { margin-bottom: 0.5rem; }
.mb-4 { margin-bottom: 1rem; }

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--gray-200);
    border-top-color: var(--primary-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--transition-normal);
}
.loading-overlay.active { opacity: 1; pointer-events: all; }

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: var(--radius-md);
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
}
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-primary { background: var(--primary-blue); color: var(--white); }
.btn-primary:hover:not(:disabled) { background: var(--primary-blue-light); }
.btn-secondary { background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-300); }
.btn-secondary:hover:not(:disabled) { background: var(--gray-200); }
.btn-success { background: var(--primary-green); color: white; }
.btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
.btn-lg { padding: 0.875rem 1.75rem; font-size: 1rem; }

.form-group { margin-bottom: 1rem; }
.form-label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.375rem; }
.form-input, .form-select {
    width: 100%;
    padding: 0.625rem 0.875rem;
    font-size: 0.875rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    background: var(--white);
    color: var(--gray-800);
}
.form-input:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1); }
.form-checkbox { width: 1rem; height: 1rem; cursor: pointer; }

.toggle { position: relative; width: 44px; height: 24px; cursor: pointer; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--gray-300);
    border-radius: var(--radius-full);
    transition: var(--transition-fast);
}
.toggle-slider::before {
    content: '';
    position: absolute;
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: var(--transition-fast);
}
.toggle input:checked + .toggle-slider { background: var(--primary-green); }
.toggle input:checked + .toggle-slider::before { transform: translateX(20px); }

.card {
    background: var(--white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
}
.card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--gray-200);
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.card-body { padding: 1.25rem; }

.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: var(--radius-full);
    text-transform: uppercase;
    letter-spacing: 0.025em;
}
.badge-grade-aa { background: #d1fae5; color: var(--grade-aa); }
.badge-grade-a { background: #d1fae5; color: var(--grade-a); }
.badge-grade-b { background: #fef3c7; color: #b45309; }
.badge-grade-c { background: #fee2e2; color: var(--grade-c); }
.badge-grade-d { background: #fee2e2; color: var(--grade-d); }
.badge-active { background: #d1fae5; color: var(--status-active); }
.badge-expiring { background: #fef3c7; color: #b45309; }
.badge-expired { background: #fee2e2; color: var(--status-expired); }

.tooltip { position: relative; cursor: help; }
.tooltip-content {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 0.5rem 0.75rem;
    background: var(--gray-800);
    color: white;
    font-size: 0.75rem;
    border-radius: var(--radius-md);
    max-width: 280px;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-fast);
    z-index: 100;
    margin-bottom: 0.5rem;
}
.tooltip:hover .tooltip-content { opacity: 1; visibility: visible; }

.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
}
.modal-backdrop.active { opacity: 1; visibility: visible; }
.modal {
    background: var(--white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow: auto;
    transform: scale(0.9);
    transition: transform var(--transition-normal);
}
.modal-backdrop.active .modal { transform: scale(1); }
.modal-lg { max-width: 800px; }
.modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.modal-title { font-size: 1.125rem; font-weight: 600; }
.modal-close { background: none; border: none; font-size: 1.25rem; color: var(--gray-500); cursor: pointer; }
.modal-body { padding: 1.5rem; }
.modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); display: flex; gap: 0.75rem; justify-content: flex-end; }

.app-layout { display: flex; min-height: 100vh; }
.sidebar {
    width: 260px;
    background: var(--primary-blue);
    color: white;
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 100;
    transition: transform var(--transition-normal);
}
.sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem; font-weight: 700; }
.sidebar-logo i { font-size: 1.75rem; color: var(--primary-green-light); }
.sidebar-nav { flex: 1; padding: 1rem 0; overflow-y: auto; }
.nav-section { margin-bottom: 1.5rem; }
.nav-section-title { padding: 0.5rem 1.5rem; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.5); }
.nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1.5rem;
    color: rgba(255,255,255,0.8);
    font-size: 0.875rem;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    transition: all var(--transition-fast);
}
.nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
.nav-item.active { background: rgba(255,255,255,0.15); color: white; border-right: 3px solid var(--primary-green-light); }
.nav-item i { width: 20px; text-align: center; }
.nav-item .badge { margin-left: auto; background: var(--accent-orange); color: white; font-size: 0.6875rem; }
.sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); }
.user-info { display: flex; align-items: center; gap: 0.75rem; }
.user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary-green); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; }
.user-name { font-size: 0.875rem; font-weight: 500; }
.user-role { font-size: 0.75rem; color: rgba(255,255,255,0.6); }

.main-content { flex: 1; margin-left: 260px; min-height: 100vh; }
.topbar {
    background: var(--white);
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
}
.topbar-left { display: flex; align-items: center; gap: 1rem; }
.mobile-menu-btn { display: none; background: none; border: none; font-size: 1.25rem; color: var(--gray-600); cursor: pointer; }
.search-bar { position: relative; width: 320px; }
.search-bar input {
    width: 100%;
    padding: 0.625rem 1rem 0.625rem 2.5rem;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-full);
    background: var(--gray-50);
    font-size: 0.875rem;
}
.search-bar input:focus { outline: none; border-color: var(--primary-blue); background: var(--white); }
.search-bar i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray-400); }
.topbar-right { display: flex; align-items: center; gap: 0.5rem; }
.topbar-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: var(--gray-100);
    color: var(--gray-600);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
.topbar-btn:hover { background: var(--gray-200); }
.notification-dot { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; }

.page-content { padding: 2rem; }
.page-header { margin-bottom: 2rem; }
.page-title { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem; }
.page-subtitle { color: var(--gray-500); font-size: 0.875rem; }

.auth-screen {
    min-height: 100vh;
    display: flex;
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
}
.auth-left { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 3rem; color: white; }
.auth-brand { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; }
.auth-brand i { font-size: 2rem; color: var(--primary-green-light); }
.auth-tagline { font-size: 2.5rem; font-weight: 700; line-height: 1.2; margin-bottom: 1rem; }
.auth-description { font-size: 1.125rem; opacity: 0.9; max-width: 450px; }
.auth-features { margin-top: 3rem; }
.auth-feature { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem; }
.auth-feature i { font-size: 1.25rem; color: var(--primary-green-light); }
.auth-feature-text h4 { font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem; }
.auth-feature-text p { font-size: 0.875rem; opacity: 0.8; }
.auth-right { width: 480px; background: var(--white); display: flex; align-items: center; justify-content: center; padding: 3rem; }
.auth-form-container { width: 100%; max-width: 360px; }
.auth-form-title { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.5rem; }
.auth-form-subtitle { color: var(--gray-500); margin-bottom: 2rem; }
.auth-tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 1px solid var(--gray-200); }
.auth-tab { flex: 1; padding: 0.75rem; text-align: center; font-weight: 500; color: var(--gray-500); border: none; background: none; cursor: pointer; position: relative; }
.auth-tab.active { color: var(--primary-blue); }
.auth-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--primary-blue); }
.auth-divider { display: flex; align-items: center; gap: 1rem; margin: 1.5rem 0; color: var(--gray-400); font-size: 0.8125rem; }
.auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--gray-200); }
.social-login { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
.social-btn { flex: 1; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: var(--radius-md); background: var(--white); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem; color: var(--gray-700); }
.social-btn:hover { background: var(--gray-50); }
.auth-footer { text-align: center; margin-top: 1.5rem; font-size: 0.875rem; color: var(--gray-500); }
.auth-footer a { color: var(--primary-blue); text-decoration: none; font-weight: 500; }

.onboarding-screen { min-height: 100vh; background: var(--gray-50); display: flex; flex-direction: column; }
.onboarding-header { background: var(--white); padding: 1rem 2rem; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: space-between; }
.onboarding-logo { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: var(--primary-blue); }
.onboarding-logo i { color: var(--primary-green); }
.onboarding-progress { display: flex; align-items: center; gap: 0.5rem; }
.progress-step { width: 8px; height: 8px; border-radius: 50%; background: var(--gray-200); }
.progress-step.active { background: var(--primary-blue); width: 24px; border-radius: 4px; }
.progress-step.completed { background: var(--primary-green); }
.onboarding-content { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; }
.onboarding-card { background: var(--white); border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); max-width: 560px; width: 100%; padding: 2.5rem; }
.onboarding-icon { width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; margin-bottom: 1.5rem; }
.onboarding-title { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.75rem; }
.onboarding-text { color: var(--gray-600); margin-bottom: 2rem; line-height: 1.7; }
.api-key-info { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 1.5rem; }
.api-key-info h4 { font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
.api-key-info h4 i { color: var(--primary-blue); }
.api-key-info p { font-size: 0.8125rem; color: var(--gray-600); }
.onboarding-actions { display: flex; gap: 1rem; margin-top: 2rem; }

.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
.stat-card { background: var(--white); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); }
.stat-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem; }
.stat-icon { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
.stat-icon.blue { background: #dbeafe; color: #2563eb; }
.stat-icon.green { background: #d1fae5; color: #059669; }
.stat-icon.yellow { background: #fef3c7; color: #d97706; }
.stat-icon.purple { background: #e9d5ff; color: #9333ea; }
.stat-trend { display: flex; align-items: center; gap: 0.25rem; font-size: 0.8125rem; font-weight: 500; }
.stat-trend.up { color: var(--primary-green); }
.stat-value { font-size: 1.75rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem; }
.stat-label { font-size: 0.875rem; color: var(--gray-500); }
.dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }

.supplier-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
.supplier-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 1.25rem; cursor: pointer; transition: all var(--transition-fast); border: 2px solid transparent; }
.supplier-card:hover { box-shadow: var(--shadow-lg); border-color: var(--primary-blue); }
.supplier-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem; }
.supplier-card-title { font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem; }
.supplier-card-location { font-size: 0.8125rem; color: var(--gray-500); display: flex; align-items: center; gap: 0.25rem; }
.supplier-card-grade { font-size: 1.25rem; font-weight: 700; padding: 0.25rem 0.625rem; border-radius: var(--radius-md); }
.supplier-card-details { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.8125rem; }
.detail-item { display: flex; flex-direction: column; }
.detail-label { color: var(--gray-500); margin-bottom: 0.125rem; }
.detail-value { color: var(--gray-800); font-weight: 500; }
.supplier-card-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-100); }
.favourite-btn { background: none; border: none; color: var(--gray-400); cursor: pointer; font-size: 1.25rem; transition: all var(--transition-fast); }
.favourite-btn:hover, .favourite-btn.active { color: var(--accent-yellow); }

.alert-item { display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--gray-100); }
.alert-item:last-child { border-bottom: none; }
.alert-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; flex-shrink: 0; }
.alert-icon.warning { background: #fef3c7; color: #d97706; }
.alert-icon.danger { background: #fee2e2; color: #dc2626; }
.alert-icon.info { background: #dbeafe; color: #2563eb; }
.alert-icon.success { background: #d1fae5; color: #059669; }
.alert-title { font-size: 0.875rem; font-weight: 500; color: var(--gray-800); margin-bottom: 0.125rem; }
.alert-time { font-size: 0.75rem; color: var(--gray-500); }

.filters-bar { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }
.filter-group { display: flex; align-items: center; gap: 0.5rem; }
.filter-label { font-size: 0.8125rem; color: var(--gray-600); font-weight: 500; }
.filter-select { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-200); border-radius: var(--radius-md); font-size: 0.8125rem; background: var(--white); min-width: 140px; }
.view-toggle { display: flex; border: 1px solid var(--gray-200); border-radius: var(--radius-md); overflow: hidden; margin-left: auto; }
.view-toggle button { padding: 0.5rem 0.75rem; border: none; background: var(--white); cursor: pointer; color: var(--gray-500); }
.view-toggle button.active { background: var(--primary-blue); color: white; }

.data-table { width: 100%; border-collapse: collapse; }
.data-table th, .data-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--gray-100); }
.data-table th { background: var(--gray-50); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--gray-600); }
.data-table tr:hover td { background: var(--gray-50); }
.table-company { display: flex; align-items: center; gap: 0.75rem; }
.company-logo { width: 40px; height: 40px; border-radius: var(--radius-md); background: var(--gray-200); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--gray-600); font-size: 0.875rem; }

.tabs { display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; }
.tab { padding: 0.875rem 1.25rem; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); background: none; border: none; cursor: pointer; position: relative; }
.tab:hover { color: var(--gray-700); }
.tab.active { color: var(--primary-blue); }
.tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--primary-blue); }
.tab-count { background: var(--gray-100); color: var(--gray-600); font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: var(--radius-full); margin-left: 0.5rem; }
.tab.active .tab-count { background: var(--primary-blue); color: white; }

.search-hero { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%); padding: 2.5rem; border-radius: var(--radius-xl); color: white; margin-bottom: 2rem; }
.search-hero h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
.search-hero p { opacity: 0.9; margin-bottom: 1.5rem; }
.search-form { display: flex; gap: 1rem; }
.search-input-group { flex: 1; position: relative; }
.search-input-group input { width: 100%; padding: 0.875rem 1rem 0.875rem 3rem; border: none; border-radius: var(--radius-md); font-size: 1rem; }
.search-input-group i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray-400); }
.search-filters { display: flex; gap: 0.75rem; }
.search-filter-select { padding: 0.875rem 1rem; border: none; border-radius: var(--radius-md); font-size: 0.875rem; min-width: 140px; }
.results-count { font-size: 0.875rem; color: var(--gray-600); }
.results-count strong { color: var(--gray-900); }
.prospect-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 1.25rem; display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
.prospect-card:hover { box-shadow: var(--shadow-lg); }
.prospect-info { flex: 1; }
.prospect-name { font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem; }
.prospect-meta { display: flex; gap: 1rem; font-size: 0.8125rem; color: var(--gray-500); }
.prospect-actions { display: flex; gap: 0.5rem; }

.settings-layout { display: grid; grid-template-columns: 240px 1fr; gap: 2rem; }
.settings-nav { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 1rem 0; }
.settings-nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.25rem; color: var(--gray-600); cursor: pointer; border: none; background: none; width: 100%; text-align: left; font-size: 0.875rem; }
.settings-nav-item:hover { background: var(--gray-50); color: var(--gray-800); }
.settings-nav-item.active { background: var(--gray-100); color: var(--primary-blue); font-weight: 500; }
.settings-content { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 2rem; }
.settings-section { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--gray-100); }
.settings-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
.settings-title { font-size: 1.125rem; font-weight: 600; color: var(--gray-900); margin-bottom: 0.5rem; }
.settings-description { font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1.5rem; }
.settings-row { display: flex; align-items: center; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid var(--gray-100); }
.settings-row:last-child { border-bottom: none; }
.settings-row-info h4 { font-size: 0.875rem; font-weight: 500; color: var(--gray-800); margin-bottom: 0.125rem; }
.settings-row-info p { font-size: 0.8125rem; color: var(--gray-500); }

.grade-explainer { background: var(--gray-50); border-radius: var(--radius-lg); padding: 1.5rem; }
.grade-item { display: flex; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-200); }
.grade-item:last-child { border-bottom: none; }
.grade-badge-lg { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.125rem; flex-shrink: 0; }
.grade-info h4 { font-size: 0.875rem; font-weight: 600; color: var(--gray-800); margin-bottom: 0.25rem; }
.grade-info p { font-size: 0.8125rem; color: var(--gray-600); }

.empty-state { text-align: center; padding: 3rem 2rem; }
.empty-state-icon { width: 80px; height: 80px; border-radius: 50%; background: var(--gray-100); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--gray-400); margin: 0 auto 1.5rem; }
.empty-state h3 { font-size: 1.125rem; font-weight: 600; color: var(--gray-800); margin-bottom: 0.5rem; }
.empty-state p { color: var(--gray-500); font-size: 0.875rem; margin-bottom: 1.5rem; }

.toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.75rem; }
.toast { background: var(--gray-800); color: white; padding: 1rem 1.25rem; border-radius: var(--radius-md); display: flex; align-items: center; gap: 0.75rem; box-shadow: var(--shadow-lg); animation: slideIn 0.3s ease; min-width: 300px; }
.toast.success { background: var(--primary-green); }
.toast.error { background: var(--accent-red); }
.toast.warning { background: var(--accent-orange); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

.cert-details-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
.cert-detail-item { background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md); }
.cert-detail-label { font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem; }
.cert-detail-value { font-weight: 600; color: var(--gray-800); }

.nc-list { display: flex; flex-direction: column; gap: 0.75rem; }
.nc-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: var(--gray-50); border-radius: var(--radius-md); border-left: 3px solid var(--gray-300); }
.nc-item.minor { border-left-color: var(--accent-yellow); }
.nc-item.major { border-left-color: var(--accent-orange); }
.nc-type { font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; padding: 0.125rem 0.5rem; border-radius: var(--radius-sm); flex-shrink: 0; }
.nc-type.minor { background: #fef3c7; color: #b45309; }
.nc-type.major { background: #fed7aa; color: #c2410c; }
.nc-text { font-size: 0.875rem; color: var(--gray-700); }

.detail-header { display: flex; gap: 2rem; margin-bottom: 2rem; }
.detail-logo { width: 100px; height: 100px; border-radius: var(--radius-lg); background: var(--gray-200); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: var(--gray-500); flex-shrink: 0; }
.detail-info { flex: 1; }
.detail-title-row { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0.5rem; }
.detail-company-name { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); }
.detail-badges { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
.detail-meta { display: flex; gap: 2rem; margin-top: 1rem; flex-wrap: wrap; }
.meta-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--gray-600); }
.meta-item i { color: var(--gray-400); width: 16px; }
.detail-actions { display: flex; gap: 0.75rem; flex-shrink: 0; }
.detail-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }

.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
.sidebar-overlay.active { display: block; }

@media (max-width: 1200px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .dashboard-grid, .detail-grid { grid-template-columns: 1fr; }
}
@media (max-width: 992px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .mobile-menu-btn { display: block; }
    .auth-screen { flex-direction: column; }
    .auth-right { width: 100%; }
    .settings-layout { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
    .stats-grid { grid-template-columns: 1fr; }
    .topbar { padding: 1rem; }
    .search-bar { width: 100%; }
    .page-content { padding: 1rem; }
    .filters-bar { flex-direction: column; align-items: stretch; }
    .view-toggle { margin-left: 0; }
    .detail-header { flex-direction: column; }
    .search-form { flex-direction: column; }
    .search-filters { flex-wrap: wrap; }
    .auth-tagline { font-size: 1.75rem; }
    .cert-details-grid { grid-template-columns: 1fr; }
}
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
    <div id="toastContainer" class="toast-container"></div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-left">
            <div class="auth-brand">
                <i class="fas fa-shield-check"></i>
                MeatCert Pro
            </div>
            <h1 class="auth-tagline">Streamline Your BRCGS Certification Management</h1>
            <p class="auth-description">
                The comprehensive platform for meat industry professionals to verify, track, and manage supplier certifications with ease.
            </p>
            <div class="auth-features">
                <div class="auth-feature">
                    <i class="fas fa-check-circle"></i>
                    <div class="auth-feature-text">
                        <h4>Real-Time Verification</h4>
                        <p>Instantly verify supplier certification status and grades</p>
                    </div>
                </div>
                <div class="auth-feature">
                    <i class="fas fa-bell"></i>
                    <div class="auth-feature-text">
                        <h4>Proactive Alerts</h4>
                        <p>Get notified before certifications expire or grades change</p>
                    </div>
                </div>
                <div class="auth-feature">
                    <i class="fas fa-file-alt"></i>
                    <div class="auth-feature-text">
                        <h4>Audit Reports Access</h4>
                        <p>View detailed audit reports and non-conformity details</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-form-container">
                <h2 class="auth-form-title">Welcome</h2>
                <p class="auth-form-subtitle">Sign in to your account or create a new one</p>
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">Sign In</button>
                    <button class="auth-tab" data-tab="signup">Sign Up</button>
                </div>
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="you@company.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="••••••••" required>
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">
                            <input type="checkbox" class="form-checkbox"> Remember me
                        </label>
                        <a href="#" id="forgotPasswordLink" style="font-size: 0.875rem; color: var(--primary-blue); text-decoration: none;">Forgot password?</a>
                    </div>
                    <button type="submit" class="btn btn-primary w-full btn-lg">Sign In</button>
                </form>
                <form id="signupForm" class="auth-form hidden">
                    <div class="form-group">
                        <label class="form-label" for="signupName">Full Name</label>
                        <input type="text" id="signupName" class="form-input" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" class="form-input" placeholder="you@company.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signupCompany">Company Name</label>
                        <input type="text" id="signupCompany" class="form-input" placeholder="Your Company Ltd" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" class="form-input" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full btn-lg">Create Account</button>
                </form>
                <div class="auth-divider">or continue with</div>
                <div class="social-login">
                    <button type="button" class="social-btn"><i class="fab fa-google"></i> Google</button>
                    <button type="button" class="social-btn"><i class="fab fa-microsoft"></i> Microsoft</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ONBOARDING SCREEN -->
    <div id="onboardingScreen" class="onboarding-screen hidden">
        <div class="onboarding-header">
            <div class="onboarding-logo"><i class="fas fa-shield-check"></i> MeatCert Pro</div>
            <div class="onboarding-progress">
                <div class="progress-step completed"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
            </div>
            <button class="btn btn-secondary btn-sm" id="skipOnboarding">Skip for now</button>
        </div>
        <div class="onboarding-content">
            <div class="onboarding-card">
                <div class="onboarding-icon"><i class="fas fa-link"></i></div>
                <h2 class="onboarding-title">Connect to BRCGS Directory Pro</h2>
                <p class="onboarding-text">Link your BRCGS Directory Pro account to access detailed certification data, audit reports, and real-time updates.</p>
                <div class="api-key-info">
                    <h4><i class="fas fa-info-circle"></i> How to get your API Key</h4>
                    <p>Log into your BRCGS Directory Pro account, navigate to Settings → API Access, and generate a new API key.</p>
                </div>
                <form id="onboardingForm">
                    <div class="form-group">
                        <label class="form-label" for="apiKey">BRCGS Directory Pro API Key</label>
                        <input type="text" id="apiKey" class="form-input" placeholder="Enter your API key">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="organizationId">Organization ID (Optional)</label>
                        <input type="text" id="organizationId" class="form-input" placeholder="Your BRCGS Organization ID">
                    </div>
                </form>
                <div style="background: #fef3c7; border-radius: var(--radius-md); padding: 1rem; margin-top: 1rem;">
                    <p style="font-size: 0.8125rem; color: #92400e;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Don't have BRCGS Directory Pro? <a href="#" style="color: #92400e; font-weight: 500;">Upgrade now</a>
                    </p>
                </div>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" id="skipApiSetup">Skip for now</button>
                    <button class="btn btn-primary" id="connectApi">Connect Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appLayout" class="app-layout hidden">
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><i class="fas fa-shield-check"></i><span>MeatCert Pro</span></div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main Menu</div>
                    <button class="nav-item active" data-screen="dashboard"><i class="fas fa-home"></i><span>Dashboard</span></button>
                    <button class="nav-item" data-screen="suppliers"><i class="fas fa-building"></i><span>Suppliers</span><span class="badge">12</span></button>
                    <button class="nav-item" data-screen="prospects"><i class="fas fa-search"></i><span>Prospect Search</span></button>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Monitoring</div>
                    <button class="nav-item" data-screen="alerts"><i class="fas fa-bell"></i><span>Alerts</span><span class="badge">3</span></button>
                    <button class="nav-item" data-screen="reports"><i class="fas fa-chart-bar"></i><span>Reports</span></button>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <button class="nav-item" data-screen="settings"><i class="fas fa-cog"></i><span>Settings</span></button>
                    <button class="nav-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">JD</div>
                    <div>
                        <div class="user-name" id="userName">John Doe</div>
                        <div class="user-role">Quality Manager</div>
                    </div>
                </div>
            </div>
        </aside>
        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearch" placeholder="Search companies, certifications...">
                    </div>
                </div>
                <div class="topbar-right">
                    <button class="topbar-btn" id="gradeExplainerBtn"><i class="fas fa-info-circle"></i></button>
                    <button class="topbar-btn" id="notificationsBtn"><i class="fas fa-bell"></i><span class="notification-dot"></span></button>
                    <button class="topbar-btn" id="darkModeToggle"><i class="fas fa-moon"></i></button>
                </div>
            </header>
            <div class="page-content" id="pageContent"></div>
        </main>
    </div>

    <!-- GRADE EXPLAINER MODAL -->
    <div id="gradeExplainerModal" class="modal-backdrop">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-award" style="color: var(--primary-green); margin-right: 0.5rem;"></i>BRCGS Grading System</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--gray-600); margin-bottom: 1.5rem;">BRCGS grades are determined by the number and severity of non-conformities. A "+" suffix indicates an unannounced audit.</p>
                <div class="grade-explainer">
                    <div class="grade-item">
                        <div class="grade-badge-lg" style="background: #d1fae5; color: var(--grade-aa);">AA</div>
                        <div class="grade-info"><h4>Grade AA (Excellent)</h4><p>No more than 5 minor non-conformities</p></div>
                    </div>
                    <div class="grade-item">
                        <div class="grade-badge-lg" style="background: #d1fae5; color: var(--grade-a);">A</div>
                        <div class="grade-info"><h4>Grade A (Very Good)</h4><p>6 to 10 minor non-conformities</p></div>
                    </div>
                    <div class="grade-item">
                        <div class="grade-badge-lg" style="background: #fef3c7; color: #b45309;">B</div>
                        <div class="grade-info"><h4>Grade B (Good)</h4><p>11-16 minors OR 1 major + up to 10 minors</p></div>
                    </div>
                    <div class="grade-item">
                        <div class="grade-badge-lg" style="background: #fed7aa; color: #c2410c;">C</div>
                        <div class="grade-info"><h4>Grade C (Acceptable)</h4><p>17-24 minors OR 1 major + 16 minors OR 2 majors + 10 minors</p></div>
                    </div>
                    <div class="grade-item">
                        <div class="grade-badge-lg" style="background: #fee2e2; color: var(--grade-d);">D</div>
                        <div class="grade-info"><h4>Grade D (Marginal)</h4><p>25-30 minors OR 1 major + 24 minors OR 2 majors + 16 minors</p></div>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-md);">
                    <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Non-Conformity Types:</h4>
                    <ul style="font-size: 0.8125rem; color: var(--gray-600); padding-left: 1.25rem;">
                        <li><strong>Minor:</strong> Small deviation from requirements</li>
                        <li><strong>Major:</strong> Raises significant doubt about product conformity</li>
                        <li><strong>Critical:</strong> Direct food safety or legal issue - certification failure</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary modal-cancel">Got it</button>
            </div>
        </div>
    </div>

    <!-- AUDIT REPORT MODAL -->
    <div id="auditReportModal" class="modal-backdrop">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Audit Report</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="auditReportContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary"><i class="fas fa-envelope"></i> Request Full Report</button>
                <button class="btn btn-primary" onclick="exportReport('audit')"><i class="fas fa-download"></i> Export PDF</button>
            </div>
        </div>
    </div>

    <!-- CSV UPLOAD MODAL -->
    <div id="csvUploadModal" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Suppliers from CSV</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Upload a CSV file containing supplier information.</p>
                <div style="border: 2px dashed var(--gray-300); border-radius: var(--radius-lg); padding: 2rem; text-align: center; cursor: pointer;" id="csvDropZone">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: var(--gray-400); margin-bottom: 1rem; display: block;"></i>
                    <p style="font-weight: 500; color: var(--gray-700);">Drop your CSV file here</p>
                    <p style="font-size: 0.8125rem; color: var(--gray-500);">or click to browse</p>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="importCsvConfirmBtn" disabled>Import Suppliers</button>
            </div>
        </div>
    </div>

<script>
// ==================== MOCK DATA ====================
const MOCK_SUPPLIERS = [
    { id: 1, name: "Madrid Meat Co.", location: "Madrid, Spain", country: "Spain", status: "active", grade: "AA", gradeUnannounced: true, scope: "Slaughter & Primary Processing", scopeDetails: ["Beef Slaughter", "Cutting & Deboning", "Chilled Storage"], certNumber: "BRCGS-ES-001234", certBody: "SGS España", auditDate: "2025-08-15", expiryDate: "2026-08-14", nonConformities: [{ type: "minor", text: "Temperature log incomplete on 2 days" }, { type: "minor", text: "Staff training records need updating" }], isFavourite: true, employees: 245, products: ["Beef cuts", "Mince", "Offal"], animalWelfare: true, halalCertified: false },
    { id: 2, name: "Barcelona Premium Pork", location: "Barcelona, Spain", country: "Spain", status: "active", grade: "A", gradeUnannounced: false, scope: "Meat Processing & Packaging", scopeDetails: ["Pork Processing", "Vacuum Packaging"], certNumber: "BRCGS-ES-002345", certBody: "Bureau Veritas", auditDate: "2025-06-20", expiryDate: "2026-06-19", nonConformities: [{ type: "minor", text: "Pest control inspection frequency below target" }, { type: "minor", text: "Foreign body detection calibration documentation gap" }, { type: "minor", text: "Supplier approval process needs strengthening" }, { type: "minor", text: "Internal audit schedule delayed" }, { type: "minor", text: "HACCP review meeting minutes incomplete" }, { type: "minor", text: "Allergen storage area signage worn" }], isFavourite: true, employees: 180, products: ["Pork loin", "Bacon", "Ham"], animalWelfare: true, halalCertified: false },
    { id: 3, name: "Valencia Fresh Meats", location: "Valencia, Spain", country: "Spain", status: "expiring", grade: "B", gradeUnannounced: false, scope: "Cutting & Cold Storage", scopeDetails: ["Beef Cutting", "Cold Chain Management"], certNumber: "BRCGS-ES-003456", certBody: "DNV GL", auditDate: "2025-01-10", expiryDate: "2026-01-25", nonConformities: [{ type: "major", text: "Temperature deviation not adequately documented" }, { type: "minor", text: "Cleaning schedule not consistently followed" }, { type: "minor", text: "Product labeling errors found" }, { type: "minor", text: "Staff hygiene training overdue" }], isFavourite: false, employees: 95, products: ["Beef portions", "Veal cuts"], animalWelfare: false, halalCertified: false },
    { id: 4, name: "Northern Ireland Lamb Ltd", location: "Belfast, UK", country: "United Kingdom", status: "active", grade: "AA", gradeUnannounced: true, scope: "Lamb Slaughter & Processing", scopeDetails: ["Lamb Slaughter", "Portioning", "Chilled Distribution"], certNumber: "BRCGS-UK-004567", certBody: "LRQA", auditDate: "2025-09-01", expiryDate: "2026-08-31", nonConformities: [{ type: "minor", text: "Minor labeling inconsistency on batch 2456" }], isFavourite: true, employees: 320, products: ["Lamb legs", "Lamb chops", "Ground lamb"], animalWelfare: true, halalCertified: true },
    { id: 5, name: "Dutch Veal Specialists", location: "Rotterdam, Netherlands", country: "Netherlands", status: "active", grade: "A", gradeUnannounced: true, scope: "Veal Processing", scopeDetails: ["Veal Cutting", "Mincing", "Packaging"], certNumber: "BRCGS-NL-005678", certBody: "Kiwa", auditDate: "2025-07-12", expiryDate: "2026-07-11", nonConformities: [{ type: "minor", text: "Water quality testing frequency reduced" }, { type: "minor", text: "Knife sterilization temperature monitoring gap" }, { type: "minor", text: "Document control system needs update" }, { type: "minor", text: "Visitor hygiene policy not clearly posted" }], isFavourite: false, employees: 150, products: ["Veal escalopes", "Veal mince"], animalWelfare: true, halalCertified: false },
    { id: 6, name: "German Premium Beef GmbH", location: "Munich, Germany", country: "Germany", status: "active", grade: "AA", gradeUnannounced: false, scope: "Beef Slaughter & Distribution", scopeDetails: ["Cattle Slaughter", "Carcass Grading", "Export Packaging"], certNumber: "BRCGS-DE-006789", certBody: "TÜV SÜD", auditDate: "2025-10-05", expiryDate: "2026-10-04", nonConformities: [{ type: "minor", text: "Traceability test took 4.5 hours instead of target 4" }, { type: "minor", text: "Emergency lighting test overdue by 3 days" }], isFavourite: true, employees: 420, products: ["Premium beef", "Dry-aged beef"], animalWelfare: true, halalCertified: false },
    { id: 7, name: "Polish Poultry Partners", location: "Warsaw, Poland", country: "Poland", status: "active", grade: "B", gradeUnannounced: false, scope: "Poultry Processing", scopeDetails: ["Chicken Slaughter", "Portion Cutting", "Frozen Products"], certNumber: "BRCGS-PL-007890", certBody: "SGS Polska", auditDate: "2025-04-18", expiryDate: "2026-04-17", nonConformities: [{ type: "major", text: "Pathogen control sampling plan not risk-based" }, { type: "minor", text: "CCP monitoring records illegible in places" }, { type: "minor", text: "Corrective action closure delayed" }, { type: "minor", text: "Shelf life validation needs review" }, { type: "minor", text: "Supplier specification files incomplete" }, { type: "minor", text: "Metal detector test pieces not calibrated" }], isFavourite: false, employees: 560, products: ["Chicken breast", "Wings", "Drumsticks"], animalWelfare: false, halalCertified: true },
    { id: 8, name: "French Foie Gras Artisans", location: "Toulouse, France", country: "France", status: "expired", grade: "C", gradeUnannounced: false, scope: "Duck & Goose Processing", scopeDetails: ["Foie Gras Production", "Confit Processing"], certNumber: "BRCGS-FR-008901", certBody: "Bureau Veritas", auditDate: "2024-11-20", expiryDate: "2025-11-19", nonConformities: [{ type: "major", text: "HACCP plan not updated for new product line" }, { type: "major", text: "Temperature abuse incident not properly investigated" }, { type: "minor", text: "Staff hand washing compliance below 80%" }, { type: "minor", text: "Cleaning chemical concentration not verified" }, { type: "minor", text: "Pest control report action items open" }], isFavourite: false, employees: 85, products: ["Foie gras", "Duck confit"], animalWelfare: false, halalCertified: false },
    { id: 9, name: "Italian Salumi Tradizione", location: "Parma, Italy", country: "Italy", status: "active", grade: "A", gradeUnannounced: false, scope: "Cured Meats Production", scopeDetails: ["Dry Curing", "Fermented Products", "Aging Facilities"], certNumber: "BRCGS-IT-009012", certBody: "CSQA", auditDate: "2025-05-25", expiryDate: "2026-05-24", nonConformities: [{ type: "minor", text: "Humidity control calibration records missing" }, { type: "minor", text: "Aging room temperature mapping overdue" }, { type: "minor", text: "Finished product testing delayed" }, { type: "minor", text: "Customer complaint trending analysis not performed" }, { type: "minor", text: "Management review meeting postponed" }, { type: "minor", text: "New starter training checklist incomplete" }], isFavourite: true, employees: 125, products: ["Prosciutto", "Salami", "Pancetta"], animalWelfare: true, halalCertified: false },
    { id: 10, name: "Danish Bacon Excellence", location: "Copenhagen, Denmark", country: "Denmark", status: "active", grade: "AA", gradeUnannounced: true, scope: "Bacon Production & Smoking", scopeDetails: ["Pork Curing", "Smoking", "Slicing & Packaging"], certNumber: "BRCGS-DK-010123", certBody: "DNV GL", auditDate: "2025-08-28", expiryDate: "2026-08-27", nonConformities: [{ type: "minor", text: "Smoke generator maintenance log gap" }, { type: "minor", text: "Packaging integrity test results filing delay" }], isFavourite: true, employees: 290, products: ["Streaky bacon", "Back bacon", "Bacon bits"], animalWelfare: true, halalCertified: false },
    { id: 11, name: "Portuguese Iberico Farms", location: "Lisbon, Portugal", country: "Portugal", status: "expiring", grade: "A", gradeUnannounced: false, scope: "Iberian Pork Products", scopeDetails: ["Iberico Pork Processing", "Acorn-Fed Specialties"], certNumber: "BRCGS-PT-011234", certBody: "SGS Portugal", auditDate: "2025-02-14", expiryDate: "2026-02-13", nonConformities: [{ type: "minor", text: "Origin verification documentation inconsistent" }, { type: "minor", text: "Acorn-fed claim validation process unclear" }, { type: "minor", text: "Cold room door seal worn" }, { type: "minor", text: "Cleaning validation swab results trending up" }, { type: "minor", text: "Pest activity near exterior loading bay" }], isFavourite: false, employees: 110, products: ["Iberico ham", "Iberico pork belly"], animalWelfare: true, halalCertified: false },
    { id: 12, name: "Swiss Alpine Meats AG", location: "Zurich, Switzerland", country: "Switzerland", status: "active", grade: "AA", gradeUnannounced: true, scope: "Premium Beef & Game", scopeDetails: ["Beef Processing", "Venison", "Wild Boar"], certNumber: "BRCGS-CH-012345", certBody: "SGS Switzerland", auditDate: "2025-09-10", expiryDate: "2026-09-09", nonConformities: [{ type: "minor", text: "Venison traceability test took 5 hours" }, { type: "minor", text: "Game species DNA testing frequency reduced" }], isFavourite: false, employees: 75, products: ["Grass-fed beef", "Venison", "Wild boar sausage"], animalWelfare: true, halalCertified: false }
];

const MOCK_PROSPECTS = [
    { id: 101, name: "Belgian Beef Brothers", location: "Brussels, Belgium", country: "Belgium", status: "active", scope: "Beef Processing" },
    { id: 102, name: "Austrian Alps Meat Co", location: "Vienna, Austria", country: "Austria", status: "active", scope: "Lamb & Game Processing" },
    { id: 103, name: "Irish Premium Angus", location: "Dublin, Ireland", country: "Ireland", status: "active", scope: "Angus Beef Specialists" },
    { id: 104, name: "Greek Lamb Exports", location: "Athens, Greece", country: "Greece", status: "active", scope: "Lamb Slaughter & Export" },
    { id: 105, name: "Norwegian Reindeer Products", location: "Oslo, Norway", country: "Norway", status: "active", scope: "Reindeer & Game Meats" }
];

const MOCK_ALERTS = [
    { id: 1, type: "warning", title: "Valencia Fresh Meats certification expiring in 8 days", company: "Valencia Fresh Meats", time: "2 hours ago", read: false },
    { id: 2, type: "danger", title: "French Foie Gras Artisans certification has expired", company: "French Foie Gras Artisans", time: "1 day ago", read: false },
    { id: 3, type: "info", title: "Portuguese Iberico Farms certification expiring in 27 days", company: "Portuguese Iberico Farms", time: "2 days ago", read: false },
    { id: 4, type: "success", title: "Danish Bacon Excellence renewed with AA+ grade", company: "Danish Bacon Excellence", time: "3 days ago", read: true },
    { id: 5, type: "warning", title: "Polish Poultry Partners grade dropped from A to B", company: "Polish Poultry Partners", time: "1 week ago", read: true }
];

// ==================== APP STATE ====================
const AppState = {
    currentScreen: 'dashboard',
    currentUser: null,
    suppliers: [...MOCK_SUPPLIERS],
    prospects: [...MOCK_PROSPECTS],
    alerts: [...MOCK_ALERTS],
    favouriteLimit: 250,
    favouriteCount: MOCK_SUPPLIERS.filter(s => s.isFavourite).length,
    darkMode: false,
    filters: { grade: 'all', status: 'all', country: 'all' },
    sortBy: 'name',
    sortOrder: 'asc',
    viewMode: 'grid',
    currentTab: 'suppliers'
};

// ==================== UTILITIES ====================
function mockApiCall(data, delay = 500) {
    return new Promise(resolve => setTimeout(() => resolve(data), delay));
}

function showLoading(message = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    overlay.querySelector('p').textContent = message;
    overlay.classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle') + '"></i><span>' + message + '</span>';
    container.appendChild(toast);
    setTimeout(() => { toast.style.animation = 'slideIn 0.3s ease reverse'; setTimeout(() => toast.remove(), 300); }, 4000);
}

function getGradeBadgeClass(grade) {
    return { 'AA': 'badge-grade-aa', 'A': 'badge-grade-a', 'B': 'badge-grade-b', 'C': 'badge-grade-c', 'D': 'badge-grade-d' }[grade] || '';
}

function getStatusBadgeClass(status) {
    return { 'active': 'badge-active', 'expiring': 'badge-expiring', 'expired': 'badge-expired' }[status] || '';
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
}

function daysUntilExpiry(expiryDate) {
    return Math.ceil((new Date(expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeAllModals() {
    document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.remove('active'));
    document.body.style.overflow = '';
}

// ==================== NAVIGATION ====================
async function navigateTo(screen, data = null) {
    showLoading();
    await mockApiCall(null, 300);
    AppState.currentScreen = screen;
    
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.screen === screen) item.classList.add('active');
    });
    
    const pageContent = document.getElementById('pageContent');
    switch(screen) {
        case 'dashboard': pageContent.innerHTML = renderDashboard(); break;
        case 'suppliers': pageContent.innerHTML = renderSuppliers(); break;
        case 'prospects': pageContent.innerHTML = renderProspects(); break;
        case 'alerts': pageContent.innerHTML = renderAlerts(); break;
        case 'settings': pageContent.innerHTML = renderSettings(); break;
        case 'reports': pageContent.innerHTML = renderReports(); break;
        case 'companyDetail': pageContent.innerHTML = renderCompanyDetail(data); break;
        default: pageContent.innerHTML = renderDashboard();
    }
    
    attachScreenHandlers(screen);
    hideLoading();
    pageContent.style.opacity = '0';
    pageContent.style.transform = 'translateY(10px)';
    requestAnimationFrame(() => {
        pageContent.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        pageContent.style.opacity = '1';
        pageContent.style.transform = 'translateY(0)';
    });
}

function showCompanyDetail(id) { navigateTo('companyDetail', id); }

// ==================== RENDERERS ====================
function renderSupplierCard(s) {
    const gradeDisplay = s.grade + (s.gradeUnannounced ? '+' : '');
    return '<div class="supplier-card" onclick="showCompanyDetail(' + s.id + ')">' +
        '<div class="supplier-card-header"><div>' +
        '<div class="supplier-card-title">' + s.name + '</div>' +
        '<div class="supplier-card-location"><i class="fas fa-map-marker-alt"></i> ' + s.location + '</div></div>' +
        '<div class="supplier-card-grade ' + getGradeBadgeClass(s.grade) + '" style="background:' + (s.grade==='AA'||s.grade==='A'?'#d1fae5':s.grade==='B'?'#fef3c7':'#fee2e2') + '">' + gradeDisplay + '</div></div>' +
        '<div class="supplier-card-details">' +
        '<div class="detail-item"><span class="detail-label">Status</span><span class="badge ' + getStatusBadgeClass(s.status) + '">' + s.status + '</span></div>' +
        '<div class="detail-item"><span class="detail-label">Expiry</span><span class="detail-value">' + formatDate(s.expiryDate) + '</span></div>' +
        '<div class="detail-item" style="grid-column:span 2"><span class="detail-label">Scope</span><span class="detail-value">' + s.scope + '</span></div></div>' +
        '<div class="supplier-card-footer"><span style="font-size:0.75rem;color:var(--gray-500)">' + s.nonConformities.length + ' non-conformities</span>' +
        '<button class="favourite-btn ' + (s.isFavourite?'active':'') + '" onclick="event.stopPropagation();toggleFavourite(' + s.id + ')"><i class="fa' + (s.isFavourite?'s':'r') + ' fa-star"></i></button></div></div>';
}

function renderDashboard() {
    const active = AppState.suppliers.filter(s => s.status === 'active').length;
    const expiring = AppState.suppliers.filter(s => s.status === 'expiring').length;
    const aaGrade = AppState.suppliers.filter(s => s.grade === 'AA').length;
    const favSuppliers = AppState.suppliers.filter(s => s.isFavourite).slice(0, 6);
    const recentAlerts = AppState.alerts.slice(0, 5);
    
    return '<div class="page-header"><h1 class="page-title">Dashboard</h1><p class="page-subtitle">Overview of your supplier certification status</p></div>' +
        '<div class="stats-grid">' +
        '<div class="stat-card"><div class="stat-header"><div class="stat-icon blue"><i class="fas fa-building"></i></div><span class="stat-trend up"><i class="fas fa-arrow-up"></i> 2</span></div><div class="stat-value">' + active + '</div><div class="stat-label">Active Suppliers</div></div>' +
        '<div class="stat-card"><div class="stat-header"><div class="stat-icon yellow"><i class="fas fa-clock"></i></div></div><div class="stat-value">' + expiring + '</div><div class="stat-label">Expiring Soon</div></div>' +
        '<div class="stat-card"><div class="stat-header"><div class="stat-icon green"><i class="fas fa-award"></i></div></div><div class="stat-value">' + aaGrade + '</div><div class="stat-label">AA Grade Suppliers</div></div>' +
        '<div class="stat-card"><div class="stat-header"><div class="stat-icon purple"><i class="fas fa-star"></i></div></div><div class="stat-value">' + AppState.favouriteCount + '/' + AppState.favouriteLimit + '</div><div class="stat-label">Favourites Used</div></div></div>' +
        '<div class="dashboard-grid"><div><div class="card"><div class="card-header"><span><i class="fas fa-star" style="color:var(--accent-yellow);margin-right:0.5rem"></i>Favourite Suppliers</span><button class="btn btn-secondary btn-sm" onclick="navigateTo(\'suppliers\')">View All</button></div>' +
        '<div class="card-body"><div class="supplier-grid">' + favSuppliers.map(s => renderSupplierCard(s)).join('') + '</div></div></div></div>' +
        '<div><div class="card"><div class="card-header"><span><i class="fas fa-bell" style="color:var(--accent-orange);margin-right:0.5rem"></i>Recent Alerts</span><button class="btn btn-secondary btn-sm" onclick="navigateTo(\'alerts\')">View All</button></div>' +
        '<div class="card-body" style="padding:0.5rem 1.25rem">' + recentAlerts.map(a => 
            '<div class="alert-item"><div class="alert-icon ' + a.type + '"><i class="fas fa-' + (a.type==='warning'?'exclamation-triangle':a.type==='danger'?'exclamation-circle':a.type==='success'?'check-circle':'info-circle') + '"></i></div>' +
            '<div class="alert-content"><div class="alert-title">' + a.title + '</div><div class="alert-time">' + a.time + '</div></div></div>'
        ).join('') + '</div></div></div></div>';
}

function filterAndSortSuppliers() {
    let filtered = [...AppState.suppliers];
    if (AppState.filters.grade !== 'all') filtered = filtered.filter(s => s.grade === AppState.filters.grade);
    if (AppState.filters.status !== 'all') filtered = filtered.filter(s => s.status === AppState.filters.status);
    if (AppState.filters.country !== 'all') filtered = filtered.filter(s => s.country === AppState.filters.country);
    const gradeOrder = { 'AA': 1, 'A': 2, 'B': 3, 'C': 4, 'D': 5 };
    filtered.sort((a, b) => {
        let cmp = 0;
        if (AppState.sortBy === 'name') cmp = a.name.localeCompare(b.name);
        else if (AppState.sortBy === 'expiry') cmp = new Date(a.expiryDate) - new Date(b.expiryDate);
        else if (AppState.sortBy === 'grade') cmp = gradeOrder[a.grade] - gradeOrder[b.grade];
        return AppState.sortOrder === 'desc' ? -cmp : cmp;
    });
    return filtered;
}

function renderSuppliers() {
    const filtered = filterAndSortSuppliers();
    const countries = [...new Set(AppState.suppliers.map(s => s.country))].sort();
    
    return '<div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h1 class="page-title">Suppliers & Customers</h1><p class="page-subtitle">Manage your certified supplier network</p></div>' +
        '<div style="display:flex;gap:0.75rem"><button class="btn btn-secondary" onclick="openModal(\'csvUploadModal\')"><i class="fas fa-upload"></i> Import CSV</button><button class="btn btn-secondary" onclick="exportReport(\'suppliers\')"><i class="fas fa-download"></i> Export</button></div></div>' +
        '<div class="tabs"><button class="tab active" data-tab="suppliers">Current Suppliers<span class="tab-count">' + AppState.suppliers.length + '</span></button><button class="tab" data-tab="customers">Customers<span class="tab-count">0</span></button></div>' +
        '<div class="filters-bar">' +
        '<div class="filter-group"><label class="filter-label">Grade:</label><select class="filter-select" id="filterGrade"><option value="all">All Grades</option><option value="AA">AA</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>' +
        '<div class="filter-group"><label class="filter-label">Status:</label><select class="filter-select" id="filterStatus"><option value="all">All Statuses</option><option value="active">Active</option><option value="expiring">Expiring Soon</option><option value="expired">Expired</option></select></div>' +
        '<div class="filter-group"><label class="filter-label">Country:</label><select class="filter-select" id="filterCountry"><option value="all">All Countries</option>' + countries.map(c => '<option value="' + c + '">' + c + '</option>').join('') + '</select></div>' +
        '<div class="filter-group"><label class="filter-label">Sort:</label><select class="filter-select" id="sortSelect"><option value="name-asc">Name (A-Z)</option><option value="name-desc">Name (Z-A)</option><option value="expiry-asc">Expiry (Soonest)</option><option value="grade-asc">Grade (Best)</option></select></div>' +
        '<div class="view-toggle"><button class="' + (AppState.viewMode==='grid'?'active':'') + '" data-view="grid"><i class="fas fa-th-large"></i></button><button class="' + (AppState.viewMode==='table'?'active':'') + '" data-view="table"><i class="fas fa-list"></i></button></div></div>' +
        '<div class="card"><div class="card-body">' + (AppState.viewMode === 'grid' ? 
            '<div class="supplier-grid">' + filtered.map(s => renderSupplierCard(s)).join('') + '</div>' :
            '<table class="data-table"><thead><tr><th>Company</th><th>Grade</th><th>Status</th><th>Scope</th><th>Expiry</th><th>Actions</th></tr></thead><tbody>' +
            filtered.map(s => '<tr onclick="showCompanyDetail(' + s.id + ')" style="cursor:pointer"><td><div class="table-company"><div class="company-logo">' + s.name.substring(0,2).toUpperCase() + '</div><div><div style="font-weight:500">' + s.name + '</div><div style="font-size:0.75rem;color:var(--gray-500)">' + s.location + '</div></div></div></td>' +
                '<td><span class="badge ' + getGradeBadgeClass(s.grade) + '">' + s.grade + (s.gradeUnannounced?'+':'') + '</span></td>' +
                '<td><span class="badge ' + getStatusBadgeClass(s.status) + '">' + s.status + '</span></td><td>' + s.scope + '</td><td>' + formatDate(s.expiryDate) + '</td>' +
                '<td><button class="favourite-btn ' + (s.isFavourite?'active':'') + '" onclick="event.stopPropagation();toggleFavourite(' + s.id + ')"><i class="fa' + (s.isFavourite?'s':'r') + ' fa-star"></i></button></td></tr>'
            ).join('') + '</tbody></table>'
        ) + '</div></div>';
}

function renderProspects() {
    return '<div class="search-hero"><h2>Find New Certified Suppliers</h2><p>Search the BRCGS directory for potential suppliers with verified certifications</p>' +
        '<div class="search-form"><div class="search-input-group"><i class="fas fa-search"></i><input type="text" id="prospectSearch" placeholder="Search by company name or location..."></div>' +
        '<div class="search-filters"><select class="search-filter-select" id="prospectCountry"><option value="">All Countries</option><option value="Spain">Spain</option><option value="UK">United Kingdom</option><option value="Germany">Germany</option><option value="France">France</option><option value="Italy">Italy</option></select>' +
        '<select class="search-filter-select" id="prospectGrade"><option value="">Min Grade</option><option value="AA">AA</option><option value="A">A</option><option value="B">B</option></select>' +
        '<button class="btn btn-success" id="searchProspectsBtn"><i class="fas fa-search"></i> Search</button></div></div></div>' +
        '<div id="prospectResults"><div style="margin-bottom:1rem"><span class="results-count">Showing <strong>' + AppState.prospects.length + '</strong> potential suppliers</span></div>' +
        AppState.prospects.map(p => '<div class="prospect-card"><div class="company-logo" style="width:50px;height:50px;font-size:1rem">' + p.name.substring(0,2).toUpperCase() + '</div>' +
            '<div class="prospect-info"><div class="prospect-name">' + p.name + '</div><div class="prospect-meta"><span><i class="fas fa-map-marker-alt"></i> ' + p.location + '</span><span><i class="fas fa-industry"></i> ' + p.scope + '</span><span class="badge badge-active">' + p.status + '</span></div></div>' +
            '<div class="prospect-actions"><button class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i> View</button><button class="btn btn-primary btn-sm" onclick="addToFavourites(' + p.id + ')"><i class="fas fa-star"></i> Add to Favourites</button></div></div>'
        ).join('') + '</div>' +
        '<div class="card mt-4"><div class="card-header"><span><i class="fas fa-lightbulb" style="color:var(--accent-yellow);margin-right:0.5rem"></i>Pro Tip</span></div>' +
        '<div class="card-body"><p style="color:var(--gray-600);font-size:0.875rem">Adding companies to favourites allows access to full certification details. You have <strong>' + (AppState.favouriteLimit - AppState.favouriteCount) + '</strong> slots remaining.</p></div></div>';
}

function renderAlerts() {
    const unreadCount = AppState.alerts.filter(a => !a.read).length;
    return '<div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h1 class="page-title">Alerts & Notifications</h1><p class="page-subtitle">Stay informed about certification changes</p></div>' +
        '<button class="btn btn-secondary" onclick="markAllAlertsRead()"><i class="fas fa-check-double"></i> Mark All Read</button></div>' +
        '<div class="card mb-4"><div class="card-header"><span>Alert Settings</span></div><div class="card-body">' +
        '<div class="settings-row"><div class="settings-row-info"><h4>Email Notifications</h4><p>Receive alerts via email</p></div><label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label></div>' +
        '<div class="settings-row"><div class="settings-row-info"><h4>SMS Notifications</h4><p>Receive critical alerts via SMS</p></div><label class="toggle"><input type="checkbox"><span class="toggle-slider"></span></label></div>' +
        '<div class="settings-row"><div class="settings-row-info"><h4>Expiry Warnings</h4><p>Alert 30, 60, 90 days before expiry</p></div><label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label></div></div></div>' +
        '<div class="card"><div class="card-header"><span>All Alerts ' + (unreadCount > 0 ? '<span class="badge" style="background:var(--accent-red);color:white">' + unreadCount + ' new</span>' : '') + '</span></div>' +
        '<div class="card-body" style="padding:0">' + AppState.alerts.map(a => 
            '<div class="alert-item" style="padding:1rem 1.25rem;' + (!a.read?'background:var(--gray-50);':'') + '">' +
            '<div class="alert-icon ' + a.type + '"><i class="fas fa-' + (a.type==='warning'?'exclamation-triangle':a.type==='danger'?'exclamation-circle':a.type==='success'?'check-circle':'info-circle') + '"></i></div>' +
            '<div class="alert-content" style="flex:1"><div class="alert-title">' + a.title + '</div><div class="alert-time">' + a.time + '</div></div>' +
            '<button class="btn btn-secondary btn-sm" onclick="viewAlertCompany(\'' + a.company + '\')">View</button></div>'
        ).join('') + '</div></div>';
}

function renderSettings() {
    return '<div class="page-header"><h1 class="page-title">Settings</h1><p class="page-subtitle">Manage your account and preferences</p></div>' +
        '<div class="settings-layout"><nav class="settings-nav">' +
        '<button class="settings-nav-item active"><i class="fas fa-user"></i> Profile</button>' +
        '<button class="settings-nav-item"><i class="fas fa-star"></i> Favourites</button>' +
        '<button class="settings-nav-item"><i class="fas fa-plug"></i> Integrations</button>' +
        '<button class="settings-nav-item"><i class="fas fa-palette"></i> Display</button></nav>' +
        '<div class="settings-content"><div class="settings-section"><h3 class="settings-title">Profile Information</h3><p class="settings-description">Update your personal information</p>' +
        '<div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" value="John Doe"></div>' +
        '<div class="form-group"><label class="form-label">Email Address</label><input type="email" class="form-input" value="john.doe@company.com"></div>' +
        '<div class="form-group"><label class="form-label">Company</label><input type="text" class="form-input" value="GlobalMeats Ltd"></div>' +
        '<button class="btn btn-primary">Save Changes</button></div>' +
        '<div class="settings-section"><h3 class="settings-title">Favourite Management</h3><p class="settings-description">Using ' + AppState.favouriteCount + ' of ' + AppState.favouriteLimit + ' slots</p>' +
        '<div style="background:var(--gray-100);border-radius:var(--radius-md);padding:1rem;margin-bottom:1rem"><div style="display:flex;justify-content:space-between;margin-bottom:0.5rem"><span style="font-size:0.875rem;font-weight:500">Favourites Used</span><span style="font-size:0.875rem;font-weight:600">' + AppState.favouriteCount + '/' + AppState.favouriteLimit + '</span></div>' +
        '<div style="height:8px;background:var(--gray-300);border-radius:var(--radius-full);overflow:hidden"><div style="height:100%;width:' + (AppState.favouriteCount/AppState.favouriteLimit*100) + '%;background:var(--primary-green);border-radius:var(--radius-full)"></div></div></div>' +
        '<button class="btn btn-success"><i class="fas fa-crown"></i> Upgrade for More</button></div>' +
        '<div class="settings-section"><h3 class="settings-title">Integrations</h3><p class="settings-description">Connect with your existing systems</p>' +
        '<div class="settings-row"><div class="settings-row-info"><h4>BRCGS Directory Pro</h4><p>Connected • Last synced 2 hours ago</p></div><button class="btn btn-secondary btn-sm">Configure</button></div>' +
        '<div class="settings-row"><div class="settings-row-info"><h4>TraceOne Integration</h4><p>Not connected</p></div><button class="btn btn-primary btn-sm">Connect</button></div></div>' +
        '<div class="settings-section"><h3 class="settings-title">Display Preferences</h3><p class="settings-description">Customize your experience</p>' +
        '<div class="settings-row"><div class="settings-row-info"><h4>Dark Mode</h4><p>Use dark theme for reduced eye strain</p></div><label class="toggle"><input type="checkbox" id="settingsDarkMode" ' + (AppState.darkMode?'checked':'') + '><span class="toggle-slider"></span></label></div>' +
        '<div class="settings-row"><div class="settings-row-info"><h4>Language</h4><p>Select your preferred language</p></div><select class="form-select" style="width:auto"><option value="en">English</option><option value="es">Español</option><option value="de">Deutsch</option></select></div></div></div></div>';
}

function renderReports() {
    return '<div class="page-header"><h1 class="page-title">Reports & Analytics</h1><p class="page-subtitle">Generate insights from your supplier data</p></div>' +
        '<div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">' +
        '<div class="card" style="text-align:center;padding:2rem"><div style="width:64px;height:64px;background:#dbeafe;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem"><i class="fas fa-file-pdf" style="font-size:1.5rem;color:#2563eb"></i></div><h3 style="font-size:1.125rem;font-weight:600;margin-bottom:0.5rem">Supplier Summary</h3><p style="font-size:0.875rem;color:var(--gray-500);margin-bottom:1rem">Overview of all supplier certifications</p><button class="btn btn-primary" onclick="exportReport(\'summary\')"><i class="fas fa-download"></i> Export PDF</button></div>' +
        '<div class="card" style="text-align:center;padding:2rem"><div style="width:64px;height:64px;background:#d1fae5;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem"><i class="fas fa-table" style="font-size:1.5rem;color:#059669"></i></div><h3 style="font-size:1.125rem;font-weight:600;margin-bottom:0.5rem">Expiry Report</h3><p style="font-size:0.875rem;color:var(--gray-500);margin-bottom:1rem">Certifications expiring in 90 days</p><button class="btn btn-primary" onclick="exportReport(\'expiry\')"><i class="fas fa-download"></i> Export CSV</button></div>' +
        '<div class="card" style="text-align:center;padding:2rem"><div style="width:64px;height:64px;background:#fef3c7;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem"><i class="fas fa-chart-bar" style="font-size:1.5rem;color:#d97706"></i></div><h3 style="font-size:1.125rem;font-weight:600;margin-bottom:0.5rem">Grade Analysis</h3><p style="font-size:0.875rem;color:var(--gray-500);margin-bottom:1rem">Distribution of supplier grades</p><button class="btn btn-primary" onclick="exportReport(\'grades\')"><i class="fas fa-download"></i> Export PDF</button></div></div>' +
        '<div class="card mt-4"><div class="card-header"><span>Grade Distribution</span></div><div class="card-body">' +
        '<div style="display:flex;justify-content:center;gap:2rem;margin-top:1rem">' +
        ['AA','A','B','C','D'].map(g => '<div style="text-align:center"><div class="badge ' + getGradeBadgeClass(g) + '" style="font-size:1rem;padding:0.5rem 1rem">' + g + '</div><div style="font-size:1.25rem;font-weight:700;margin-top:0.5rem">' + AppState.suppliers.filter(s=>s.grade===g).length + '</div><div style="font-size:0.75rem;color:var(--gray-500)">suppliers</div></div>').join('') +
        '</div></div></div>';
}

function renderCompanyDetail(supplierId) {
    const s = AppState.suppliers.find(x => x.id === supplierId);
    if (!s) return '<p>Company not found</p>';
    const gradeDisplay = s.grade + (s.gradeUnannounced ? '+' : '');
    const minorCount = s.nonConformities.filter(nc => nc.type === 'minor').length;
    const majorCount = s.nonConformities.filter(nc => nc.type === 'major').length;
    
    const gradeExplanations = {'AA':'No more than 5 minor non-conformities','A':'6 to 10 minor non-conformities','B':'11-16 minors OR 1 major + up to 10 minors','C':'17-24 minors OR 1 major + up to 16 minors OR 2 majors + up to 10 minors','D':'25-30 minors OR 1 major + up to 24 minors OR 2 majors + up to 16 minors'};
    
    return '<div class="page-header"><button class="btn btn-secondary mb-4" onclick="navigateTo(\'suppliers\')"><i class="fas fa-arrow-left"></i> Back to Suppliers</button></div>' +
        '<div class="detail-header"><div class="detail-logo">' + s.name.substring(0,2).toUpperCase() + '</div><div class="detail-info"><div class="detail-title-row"><div><h1 class="detail-company-name">' + s.name + '</h1>' +
        '<div class="detail-badges"><span class="badge ' + getGradeBadgeClass(s.grade) + '" style="font-size:1rem;padding:0.375rem 0.75rem">Grade ' + gradeDisplay + '</span><span class="badge ' + getStatusBadgeClass(s.status) + '">' + s.status + '</span>' +
        (s.animalWelfare ? '<span class="badge" style="background:#d1fae5;color:#059669"><i class="fas fa-paw"></i> Animal Welfare</span>' : '') +
        (s.halalCertified ? '<span class="badge" style="background:#dbeafe;color:#2563eb">Halal</span>' : '') + '</div></div>' +
        '<div class="detail-actions"><button class="btn btn-secondary" onclick="openAuditReport(' + s.id + ')"><i class="fas fa-file-alt"></i> Audit Report</button><button class="btn btn-primary"><i class="fas fa-envelope"></i> Request Access</button></div></div>' +
        '<div class="detail-meta"><div class="meta-item"><i class="fas fa-map-marker-alt"></i> ' + s.location + '</div><div class="meta-item"><i class="fas fa-certificate"></i> ' + s.certNumber + '</div><div class="meta-item"><i class="fas fa-users"></i> ' + s.employees + ' employees</div><div class="meta-item"><i class="fas fa-building"></i> ' + s.certBody + '</div></div></div></div>' +
        '<div class="detail-grid"><div>' +
        '<div class="card"><div class="card-header"><span><i class="fas fa-certificate" style="color:var(--primary-blue);margin-right:0.5rem"></i>Certification Details</span></div><div class="card-body"><div class="cert-details-grid">' +
        '<div class="cert-detail-item"><div class="cert-detail-label">Certificate Number</div><div class="cert-detail-value">' + s.certNumber + '</div></div>' +
        '<div class="cert-detail-item"><div class="cert-detail-label">Certification Body</div><div class="cert-detail-value">' + s.certBody + '</div></div>' +
        '<div class="cert-detail-item"><div class="cert-detail-label">Last Audit Date</div><div class="cert-detail-value">' + formatDate(s.auditDate) + '</div></div>' +
        '<div class="cert-detail-item"><div class="cert-detail-label">Expiry Date</div><div class="cert-detail-value" style="' + (daysUntilExpiry(s.expiryDate)<=30?'color:var(--accent-orange)':'') + '">' + formatDate(s.expiryDate) + '</div></div>' +
        '<div class="cert-detail-item"><div class="cert-detail-label">Audit Type</div><div class="cert-detail-value">' + (s.gradeUnannounced?'Unannounced':'Announced') + '</div></div>' +
        '<div class="cert-detail-item"><div class="cert-detail-label">Standard</div><div class="cert-detail-value">BRCGS Food Safety Issue 9</div></div></div></div></div>' +
        '<div class="card mt-4"><div class="card-header"><span><i class="fas fa-industry" style="color:var(--primary-green);margin-right:0.5rem"></i>Scope & Products</span></div><div class="card-body">' +
        '<div class="mb-4"><div class="cert-detail-label">Primary Scope</div><div class="cert-detail-value">' + s.scope + '</div></div>' +
        '<div class="mb-4"><div class="cert-detail-label">Scope Details</div><div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem">' + s.scopeDetails.map(d => '<span class="badge" style="background:var(--gray-100);color:var(--gray-700)">' + d + '</span>').join('') + '</div></div>' +
        '<div><div class="cert-detail-label">Products</div><div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem">' + s.products.map(p => '<span class="badge" style="background:var(--gray-100);color:var(--gray-700)">' + p + '</span>').join('') + '</div></div></div></div>' +
        '<div class="card mt-4"><div class="card-header"><span><i class="fas fa-exclamation-triangle" style="color:var(--accent-orange);margin-right:0.5rem"></i>Non-Conformities (' + s.nonConformities.length + ')</span></div><div class="card-body">' +
        '<div style="display:flex;gap:1rem;margin-bottom:1rem">' +
        '<div style="padding:0.75rem;background:#fef3c7;border-radius:var(--radius-md);text-align:center;flex:1"><div style="font-size:1.5rem;font-weight:700;color:#b45309">' + minorCount + '</div><div style="font-size:0.75rem;color:#92400e">Minor</div></div>' +
        '<div style="padding:0.75rem;background:#fed7aa;border-radius:var(--radius-md);text-align:center;flex:1"><div style="font-size:1.5rem;font-weight:700;color:#c2410c">' + majorCount + '</div><div style="font-size:0.75rem;color:#9a3412">Major</div></div>' +
        '<div style="padding:0.75rem;background:#fee2e2;border-radius:var(--radius-md);text-align:center;flex:1"><div style="font-size:1.5rem;font-weight:700;color:#dc2626">0</div><div style="font-size:0.75rem;color:#b91c1c">Critical</div></div></div>' +
        '<div class="nc-list">' + s.nonConformities.map(nc => '<div class="nc-item ' + nc.type + '"><span class="nc-type ' + nc.type + '">' + nc.type + '</span><span class="nc-text">' + nc.text + '</span></div>').join('') + '</div></div></div></div>' +
        '<div><div class="card"><div class="card-header"><span><i class="fas fa-bell" style="color:var(--accent-yellow);margin-right:0.5rem"></i>Alert Settings</span></div><div class="card-body">' +
        '<div class="settings-row" style="border-bottom:none;padding-top:0"><div class="settings-row-info"><h4>Expiry Alerts</h4><p>Get notified before expiry</p></div><label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label></div>' +
        '<div class="settings-row" style="border-bottom:none"><div class="settings-row-info"><h4>Grade Changes</h4><p>Alert when grade changes</p></div><label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label></div></div></div>' +
        '<div class="card mt-4"><div class="card-header"><span><i class="fas fa-award" style="color:var(--primary-blue);margin-right:0.5rem"></i>Grade Explained</span></div><div class="card-body">' +
        '<p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:1rem">This supplier achieved <strong>Grade ' + gradeDisplay + '</strong> indicating ' + (s.grade==='AA'?'excellent':s.grade==='A'?'very good':s.grade==='B'?'good':'acceptable') + ' compliance.</p>' +
        '<div style="background:var(--gray-50);padding:1rem;border-radius:var(--radius-md)"><div style="font-size:0.75rem;color:var(--gray-500);margin-bottom:0.5rem">Grade ' + s.grade + ' Requirements:</div>' +
        '<div style="font-size:0.875rem;color:var(--gray-700)">' + gradeExplanations[s.grade] + '</div></div>' +
        (s.gradeUnannounced ? '<div style="margin-top:1rem;padding:0.75rem;background:#d1fae5;border-radius:var(--radius-md)"><div style="font-size:0.8125rem;color:#065f46;display:flex;align-items:center;gap:0.5rem"><i class="fas fa-check-circle"></i><span><strong>Unannounced Audit (+)</strong> - Higher confidence in day-to-day practices</span></div></div>' : '') + '</div></div>' +
        '<div class="card mt-4"><div class="card-header"><span><i class="fas fa-clock" style="color:var(--gray-500);margin-right:0.5rem"></i>Quick Actions</span></div><div class="card-body">' +
        '<button class="btn btn-secondary w-full mb-2" onclick="exportReport(\'supplier-' + s.id + '\')"><i class="fas fa-download"></i> Export Details</button>' +
        '<button class="btn btn-secondary w-full mb-2"><i class="fas fa-print"></i> Print Summary</button>' +
        '<button class="btn btn-secondary w-full" onclick="toggleFavourite(' + s.id + ');navigateTo(\'companyDetail\',' + s.id + ')"><i class="fa' + (s.isFavourite?'s':'r') + ' fa-star"></i> ' + (s.isFavourite?'Remove from':'Add to') + ' Favourites</button></div></div></div></div>';
}

// ==================== ACTIONS ====================
function toggleFavourite(id) {
    const supplier = AppState.suppliers.find(s => s.id === id);
    if (supplier) {
        if (!supplier.isFavourite && AppState.favouriteCount >= AppState.favouriteLimit) {
            showToast('Favourite limit reached! Upgrade for more slots.', 'warning');
            return;
        }
        supplier.isFavourite = !supplier.isFavourite;
        AppState.favouriteCount = AppState.suppliers.filter(s => s.isFavourite).length;
        showToast(supplier.isFavourite ? 'Added to favourites' : 'Removed from favourites', 'success');
        if (AppState.currentScreen === 'suppliers') navigateTo('suppliers');
        else if (AppState.currentScreen === 'dashboard') navigateTo('dashboard');
    }
}

function addToFavourites(id) {
    if (AppState.favouriteCount >= AppState.favouriteLimit) {
        showToast('Favourite limit reached! Upgrade for more slots.', 'warning');
        return;
    }
    showToast('Company added to favourites', 'success');
    AppState.favouriteCount++;
}

function openAuditReport(id) {
    const s = AppState.suppliers.find(x => x.id === id);
    if (!s) return;
    document.getElementById('auditReportContent').innerHTML = 
        '<div style="background:var(--gray-100);padding:1rem;border-radius:var(--radius-md);margin-bottom:1.5rem;display:flex;justify-content:space-between">' +
        '<div><h4 style="font-weight:600;margin-bottom:0.25rem">' + s.name + '</h4><p style="font-size:0.875rem;color:var(--gray-600)">' + s.certNumber + '</p></div>' +
        '<div style="text-align:right"><div class="badge ' + getGradeBadgeClass(s.grade) + '" style="font-size:1rem;padding:0.5rem 1rem">Grade ' + s.grade + (s.gradeUnannounced?'+':'') + '</div></div></div>' +
        '<div style="margin-bottom:1.5rem"><h4 style="font-size:0.9375rem;font-weight:600;margin-bottom:0.75rem">Audit Summary</h4>' +
        '<div class="cert-details-grid"><div class="cert-detail-item"><div class="cert-detail-label">Audit Date</div><div class="cert-detail-value">' + formatDate(s.auditDate) + '</div></div>' +
        '<div class="cert-detail-item"><div class="cert-detail-label">Certification Body</div><div class="cert-detail-value">' + s.certBody + '</div></div>' +
        '<div class="cert-detail-item"><div class="cert-detail-label">Audit Type</div><div class="cert-detail-value">' + (s.gradeUnannounced?'Unannounced':'Announced') + '</div></div>' +
        '<div class="cert-detail-item"><div class="cert-detail-label">Valid Until</div><div class="cert-detail-value">' + formatDate(s.expiryDate) + '</div></div></div></div>' +
        '<div style="margin-bottom:1.5rem"><h4 style="font-size:0.9375rem;font-weight:600;margin-bottom:0.75rem">Non-Conformities Found</h4>' +
        '<div class="nc-list">' + s.nonConformities.map(nc => '<div class="nc-item ' + nc.type + '"><span class="nc-type ' + nc.type + '">' + nc.type + '</span><span class="nc-text">' + nc.text + '</span></div>').join('') + '</div></div>' +
        '<div style="background:var(--gray-50);border-radius:var(--radius-md);padding:1rem;text-align:center;color:var(--gray-500);font-size:0.8125rem">' +
        '<i class="fas fa-chart-pie" style="font-size:2rem;color:var(--gray-300);display:block;margin-bottom:0.5rem"></i>Detailed audit charts available with Pro subscription</div>';
    openModal('auditReportModal');
}

function exportReport(type) {
    showLoading('Generating report...');
    setTimeout(() => {
        hideLoading();
        if (type === 'suppliers' || type.startsWith('supplier-')) {
            const data = type === 'suppliers' ? AppState.suppliers : [AppState.suppliers.find(s => s.id === parseInt(type.split('-')[1]))];
            const csv = 'Name,Location,Grade,Status,Scope,Expiry\n' + data.map(s => '"' + s.name + '","' + s.location + '","' + s.grade + '","' + s.status + '","' + s.scope + '","' + s.expiryDate + '"').join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'suppliers-export.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Report exported successfully', 'success');
        } else {
            showToast('Report generated (demo)', 'success');
        }
    }, 1000);
}

function viewAlertCompany(name) {
    const supplier = AppState.suppliers.find(s => s.name === name);
    if (supplier) showCompanyDetail(supplier.id);
    else showToast('Company not found', 'error');
}

function markAllAlertsRead() {
    AppState.alerts.forEach(a => a.read = true);
    showToast('All alerts marked as read', 'success');
    navigateTo('alerts');
}

// ==================== SCREEN HANDLERS ====================
function attachScreenHandlers(screen) {
    if (screen === 'suppliers') {
        document.getElementById('filterGrade')?.addEventListener('change', e => { AppState.filters.grade = e.target.value; navigateTo('suppliers'); });
        document.getElementById('filterStatus')?.addEventListener('change', e => { AppState.filters.status = e.target.value; navigateTo('suppliers'); });
        document.getElementById('filterCountry')?.addEventListener('change', e => { AppState.filters.country = e.target.value; navigateTo('suppliers'); });
        document.getElementById('sortSelect')?.addEventListener('change', e => {
            const [sortBy, sortOrder] = e.target.value.split('-');
            AppState.sortBy = sortBy; AppState.sortOrder = sortOrder;
            navigateTo('suppliers');
        });
        document.querySelectorAll('.view-toggle button').forEach(btn => {
            btn.addEventListener('click', () => { AppState.viewMode = btn.dataset.view; navigateTo('suppliers'); });
        });
    }
    if (screen === 'settings') {
        document.getElementById('settingsDarkMode')?.addEventListener('change', e => {
            AppState.darkMode = e.target.checked;
            document.documentElement.setAttribute('data-theme', AppState.darkMode ? 'dark' : 'light');
            document.getElementById('darkModeToggle').querySelector('i').className = 'fas fa-' + (AppState.darkMode ? 'sun' : 'moon');
        });
    }
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    // Auth tabs
    document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('loginForm').classList.toggle('hidden', tab.dataset.tab !== 'login');
            document.getElementById('signupForm').classList.toggle('hidden', tab.dataset.tab !== 'signup');
        });
    });
    
    // Login form
    document.getElementById('loginForm')?.addEventListener('submit', async e => {
        e.preventDefault();
        showLoading('Signing in...');
        await mockApiCall(null, 1000);
        AppState.currentUser = { name: 'John Doe', email: document.getElementById('loginEmail').value, company: 'GlobalMeats Ltd' };
        hideLoading();
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('onboardingScreen').classList.remove('hidden');
    });
    
    // Signup form
    document.getElementById('signupForm')?.addEventListener('submit', async e => {
        e.preventDefault();
        showLoading('Creating account...');
        await mockApiCall(null, 1000);
        AppState.currentUser = { name: document.getElementById('signupName').value, email: document.getElementById('signupEmail').value, company: document.getElementById('signupCompany').value };
        hideLoading();
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('onboardingScreen').classList.remove('hidden');
    });
    
    // Onboarding
    ['skipOnboarding', 'skipApiSetup', 'connectApi'].forEach(id => {
        document.getElementById(id)?.addEventListener('click', async () => {
            showLoading(id === 'connectApi' ? 'Connecting...' : 'Loading...');
            await mockApiCall(null, 800);
            hideLoading();
            if (id === 'connectApi') showToast('BRCGS Directory Pro connected successfully', 'success');
            document.getElementById('onboardingScreen').classList.add('hidden');
            document.getElementById('appLayout').classList.remove('hidden');
            document.getElementById('userName').textContent = AppState.currentUser?.name || 'John Doe';
            document.getElementById('userAvatar').textContent = (AppState.currentUser?.name || 'John Doe').split(' ').map(n => n[0]).join('');
            navigateTo('dashboard');
        });
    });
    
    // Sidebar navigation
    document.querySelectorAll('.nav-item[data-screen]').forEach(item => {
        item.addEventListener('click', () => navigateTo(item.dataset.screen));
    });
    
    // Logout
    document.getElementById('logoutBtn')?.addEventListener('click', () => {
        AppState.currentUser = null;
        document.getElementById('appLayout').classList.add('hidden');
        document.getElementById('authScreen').classList.remove('hidden');
        showToast('Logged out successfully', 'success');
    });
    
    // Mobile menu
    document.getElementById('mobileMenuBtn')?.addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('sidebarOverlay').classList.toggle('active');
    });
    document.getElementById('sidebarOverlay')?.addEventListener('click', () => {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('active');
    });
    
    // Topbar buttons
    document.getElementById('gradeExplainerBtn')?.addEventListener('click', () => openModal('gradeExplainerModal'));
    document.getElementById('notificationsBtn')?.addEventListener('click', () => navigateTo('alerts'));
    document.getElementById('darkModeToggle')?.addEventListener('click', () => {
        AppState.darkMode = !AppState.darkMode;
        document.documentElement.setAttribute('data-theme', AppState.darkMode ? 'dark' : 'light');
        document.getElementById('darkModeToggle').querySelector('i').className = 'fas fa-' + (AppState.darkMode ? 'sun' : 'moon');
    });
    
    // Global search
    document.getElementById('globalSearch')?.addEventListener('keyup', e => {
        if (e.key === 'Enter') {
            const query = e.target.value.toLowerCase();
            const found = AppState.suppliers.find(s => s.name.toLowerCase().includes(query));
            if (found) showCompanyDetail(found.id);
            else showToast('No supplier found matching "' + e.target.value + '"', 'warning');
        }
    });
    
    // Modal close handlers
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', e => { if (e.target === backdrop) closeAllModals(); });
    });
    document.querySelectorAll('.modal-close, .modal-cancel').forEach(btn => {
        btn.addEventListener('click', closeAllModals);
    });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllModals(); });
    
    // CSV upload
    const csvDropZone = document.getElementById('csvDropZone');
    const csvFileInput = document.getElementById('csvFileInput');
    csvDropZone?.addEventListener('click', () => csvFileInput?.click());
    csvFileInput?.addEventListener('change', e => {
        if (e.target.files.length) {
            showToast('CSV file selected: ' + e.target.files[0].name, 'success');
            document.getElementById('importCsvConfirmBtn').disabled = false;
        }
    });
    document.getElementById('importCsvConfirmBtn')?.addEventListener('click', async () => {
        showLoading('Importing suppliers...');
        await mockApiCall(null, 1500);
        hideLoading();
        closeAllModals();
        showToast('3 suppliers imported successfully', 'success');
    });
    
    // Forgot password
    document.getElementById('forgotPasswordLink')?.addEventListener('click', e => {
        e.preventDefault();
        showToast('Password reset functionality (demo)', 'info');
    });
});
</script>
</body>
</html>